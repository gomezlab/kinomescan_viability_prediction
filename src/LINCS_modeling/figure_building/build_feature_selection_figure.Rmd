---
title: "build correlation figure"
output: html_document
date: '2022-03-08'
---

```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(ggridges)
knitr::opts_knit$set(root.dir = here())
```

```{r}
#read in data

ic50_correlations = read_csv(here('results/PRISM_LINCS_klaeger_all_multiomic_data_feature_correlations.csv')) %>% 
	mutate(feature_type = 
				 	if_else(feature_type == "Activation", 
				 					"Inhibition",
				 					feature_type))
auc_correlations = read_csv(here('results/PRISM_LINCS_klaeger_all_multiomic_data_feature_correlations_auc.csv')) %>% 
		mutate(feature_type = 
				 	if_else(feature_type == "Activation", 
				 					"Inhibition",
				 					feature_type))

```

```{r}
#preprocessing
ic50_correlations_medians = ic50_correlations %>% 
	group_by(feature_type) %>% 
	summarise(median = median(abs_cor, na.rm = TRUE)) %>% 
	arrange(desc(median))

ic50_correlations_summary = ic50_correlations %>% 
	mutate(feature_type = as.factor(feature_type)) %>%  
	mutate(feature_type = 
				 	fct_relevel(feature_type, 
				 							ic50_correlations_medians$feature_type[1], 
				 							ic50_correlations_medians$feature_type[2], 
				 							ic50_correlations_medians$feature_type[3], 
				 							ic50_correlations_medians$feature_type[4] ))

auc_correlations_medians = auc_correlations %>% 
	group_by(feature_type) %>% 
	summarise(median = median(abs_cor, na.rm = TRUE)) %>% 
	arrange(desc(median))

auc_correlations_summary = auc_correlations %>% 
	mutate(feature_type = as.factor(feature_type)) %>%  
	mutate(feature_type = 
				 	fct_relevel(feature_type, 
				 							auc_correlations_medians$feature_type[1], 
				 							auc_correlations_medians$feature_type[2], 
				 							auc_correlations_medians$feature_type[3], 
				 							auc_correlations_medians$feature_type[4] ))
```


```{r}
#ic50 plot

ic50_correlations_summary %>% 
	ggplot(aes(x = abs_cor, y = feature_type, fill = factor(stat(quantile)))) +
	 stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = 4, quantile_lines = TRUE
  ) +
  scale_fill_viridis_d(name = "Quartiles") +
	theme_ridges(center_axis_labels = TRUE) + 
	labs(title = "IC50 Feature Correlations",x = "Absolute Correlation Value", y = "Data Type")
	
ggsave(here('figures/IC50_feature_correlations.png'), height = 6, width = 21, units = "cm")

auc_correlations_summary %>% 
	ggplot(aes(x = abs_cor, y = feature_type, fill = factor(stat(quantile)))) +
	 stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = 4, quantile_lines = TRUE
  ) +
  scale_fill_viridis_d(name = "Quartiles") +
	theme_ridges(center_axis_labels = TRUE) + 
	labs(title = "AUC Feature Correlations",x = "Absolute Correlation Value", y = "Data Type")
	
ggsave(here('figures/auc_feature_correlations.png'), height = 6, width = 21, units = "cm")

```

## Overall Feature Correlation Plotting

```{r}
per_group_rank = ic50_correlations_summary %>%
	group_by(feature_type) %>%
	nest() %>%
	mutate(group_rank = map(data, ~ .x %>% 
														mutate(sub_percent_rank = percent_rank(abs_cor*-1),
																	 sub_rank = 1:n()))) %>%
	unnest(cols = c(group_rank)) %>%
	ungroup() %>%
	select(feature,sub_rank,sub_percent_rank) %>%
	identity()

ic50_correlations_summary = ic50_correlations_summary %>%
	left_join(per_group_rank)
```

### By Feature Type - Overall Rank
```{r}

# ic50_correlations_summary %>%
# 	filter(rank <= 5001) %>% 
# 	ggplot(aes(x = rank, y = feature_type, fill = factor(stat(quantile)))) +
# 	 stat_density_ridges(
#     geom = "density_ridges_gradient", calc_ecdf = TRUE,
#     quantiles = 4, quantile_lines = TRUE
#   ) +
# 	scale_x_continuous(breaks=seq(0,5000,by=500)) +
#   scale_fill_viridis_d(name = "Quartiles") +
# 	theme_ridges(center_axis_labels = TRUE) + 
# 	labs(title = "IC50 Feature Selection",x = "Overall Correlation Rank", y = "Data Type")

rank_zoom = ggplot(ic50_correlations_summary %>% filter(rank <= 5001), aes(x=rank,y=sub_rank,color=feature_type)) +
	geom_vline(aes(xintercept = 100), linetype = 3) +
	geom_vline(aes(xintercept = 200), linetype = 3) +
	geom_vline(aes(xintercept = 300), linetype = 3) +
	geom_vline(aes(xintercept = 400), linetype = 3) +
	geom_vline(aes(xintercept = 500), linetype = 3) +
	geom_vline(aes(xintercept = 1000), linetype = 3) +
	geom_vline(aes(xintercept = 1500), linetype = 3) +
	geom_vline(aes(xintercept = 2000), linetype = 3) +
	geom_vline(aes(xintercept = 3000), linetype = 3) +
	geom_vline(aes(xintercept = 4000), linetype = 3) +
	geom_vline(aes(xintercept = 5000), linetype = 3) + 
	geom_line(size=1.5) +
	labs(x="Overall Correlation Rank",y="Number of Features", color='Feature Type') +
	scale_x_continuous(breaks=seq(0,5000,by=500)) +
		theme(
		panel.background = element_rect(fill = "transparent",colour = NA),
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(),
    plot.background = element_rect(fill = "transparent",colour = NA),
		axis.title = element_text(size = 14)
      ) 
	
ggsave(here('figures/feature_selection_ic50_group_rank_count.png'), height = 6, width = 21, units = "cm")
```
