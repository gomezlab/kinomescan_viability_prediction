---
title: "ALMANAC_modelling"
output: html_document
---
```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(tidymodels)
library(tictoc)
library(doParallel)
library(patchwork)
library(ROCR)
library(reticulate)
library(vip)
library(recipeselectors)
library(conflicted)
library(Metrics)
library(pROC)

conflict_prefer("slice", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("rmse", "Metrics")
conflict_prefer("auc", "pROC")
conflict_prefer("ggroc", "pROC")
conflict_prefer("vi", "vip")
knitr::opts_knit$set(root.dir = here())
```

```{r}
#read in data 
data = read_csv(here('results/PDX_LINCS_klaeger_models/PDX_klaeger_LINCS_data_for_ml.csv'))

this_dataset = data %>% 
	select(-starts_with("cnv_")) %>% 
	mutate(binary_response = as.factor(binary_response))
```

```{r}
#EDA
```


```{r}
#tuning lasso feature selection within xgboost

xgb_grid = read_rds(here('results/hyperparameter_grids/xgb_grid.rds'))

folds = vfold_cv(this_dataset, v = 5, strata = binary_response, seed = 2222)

tic()	

this_recipe = recipe(this_dataset) %>%
  update_role(-starts_with("act_"),
              -starts_with("exp_"),
              -starts_with("binary_response"),
              new_role = "id variable") %>%
	update_role(starts_with(c("act_", "exp_")), new_role = "predictor") %>% 
	update_role(binary_response, new_role = "outcome") %>%
	step_normalize(all_predictors()) %>%  
  step_zv(all_predictors()) %>% 
	step_select_linear(all_predictors(), outcome = "binary_response", engine = "glmnet", penalty = tune(), mixture = tune(), top_p = tune())

xgb_spec <- boost_tree(
  trees = tune(), 
  tree_depth = tune()
) %>% 
  set_engine("xgboost", tree_method = "gpu_hist") %>% 
  set_mode("classification")

this_wflow <-
  workflow() %>%
  add_model(xgb_spec) %>%
  add_recipe(this_recipe)

race_ctrl = control_grid(
  save_pred = TRUE, 
  parallel_over = "everything",
  verbose = TRUE
)

set.seed(2222)
recipe_grid = grid_max_entropy(
	extract_parameter_set_dials(this_recipe) %>% 
		update(top_p = top_p(c(5,2000))), 
	size = 10
)

full_grid = merge(xgb_grid, recipe_grid)

results <- tune_grid(
  this_wflow,
  resamples = folds,
  grid = full_grid,
  control = race_ctrl
) %>% 
  collect_metrics()
  
toc()


write_csv(results, here('results/PDX_LINCS_klaeger_models/PDX_LINCS_klaeger_lasso_xgboost_all_tuning_results.csv'))
```

```{r}
#fit model on whole data to get importances
data = read_csv(here('results/PDX_LINCS_klaeger_models/PDX_klaeger_LINCS_data_for_ml.csv'))

this_dataset = data %>% 
	select(-starts_with("cnv_")) %>% 
	mutate(binary_response = as.factor(binary_response))

results = read_csv(here('results/PDX_LINCS_klaeger_models/PDX_LINCS_klaeger_lasso_xgboost_all_tuning_results.csv'))

best_model = results %>% 
	filter(.metric == "roc_auc") %>% 
	arrange(desc(mean)) %>% 
	slice(1)

this_recipe = recipe(this_dataset) %>%
  update_role(-starts_with("act_"),
              -starts_with("exp_"),
              -starts_with("binary_response"),
              new_role = "id variable") %>%
	update_role(starts_with(c("act_", "exp_")), new_role = "predictor") %>% 
	update_role(binary_response, new_role = "outcome") %>%
	step_normalize(all_predictors()) %>%  
  step_zv(all_predictors())

lr_final_spec = logistic_reg(penalty = best_model$penalty, mixture = best_model$mixture) %>%
	set_engine("glmnet") %>% 
	set_mode("classification")

final_wflow <-
	workflow() %>%
	add_model(lr_final_spec) %>%
	add_recipe(this_recipe)

set.seed(2222)
final_fit = 
	final_wflow %>% 
	fit(this_dataset)

all_importance = vi(final_fit %>% extract_fit_parsnip()) %>%
	arrange(desc(Importance)) %>%
	mutate(rank = 1:n()) %>%
  filter(rank <= best_model$top_p) %>% 
  rename(feature = Variable) %>% 
  mutate(feature_type = case_when(
    str_detect(feature, "^act_") ~ "Inhibition",
    str_detect(feature, "^exp_") ~ "Baseline Gene Expression",
    T ~ feature
  )) %>% 
write_csv(here('results/PDX_LINCS_klaeger_models/lasso_selected_features.csv'))
```

```{r}
# fit best model with CV for figure
lasso_selected_features = read_csv(here('results/PDX_LINCS_klaeger_models/lasso_selected_features.csv')) %>% 
  filter(Importance > 0)

results = read_csv(here('results/PDX_LINCS_klaeger_models/PDX_LINCS_klaeger_lasso_xgboost_all_tuning_results.csv'))

best_model = results %>% 
	filter(.metric == "roc_auc") %>% 
	arrange(desc(mean)) %>% 
	slice(1)

data = read_csv(here('results/PDX_LINCS_klaeger_models/PDX_klaeger_LINCS_data_for_ml.csv'))

this_dataset = data %>% 
	select(-starts_with("cnv_")) %>% 
	mutate(binary_response = as.factor(binary_response))

id_vars = this_dataset %>% 
  select(-starts_with("act_"),
         -starts_with("exp_"),
         -starts_with("binary_response")) %>% 
  names()

model_dataset = this_dataset %>% 
  select(any_of(c(id_vars, lasso_selected_features$feature, "binary_response"))) %>% 
	write_rds((here('results/PDX_LINCS_klaeger_models/PDX_LINCS_klaeger_final_model_dataset.rds')))

folds = vfold_cv(model_dataset, v = 5, seed = 2222)

tic()	

this_recipe = recipe(model_dataset) %>%
  update_role(-starts_with("act_"),
              -starts_with("exp_"),
              -starts_with("binary_response"),
              new_role = "id variable") %>%
	update_role(starts_with(c("act_", "exp_")), new_role = "predictor") %>% 
	update_role(binary_response, new_role = "outcome")
  
  
xgb_spec <- boost_tree(
  trees = best_model$trees, 
  tree_depth = best_model$tree_depth
) %>% 
  set_engine("xgboost", tree_method = "gpu_hist") %>% 
  set_mode("classification")

this_wflow <-
  workflow() %>%
  add_model(xgb_spec) %>%
  add_recipe(this_recipe)

race_ctrl = control_resamples(
  save_pred = TRUE, 
  parallel_over = "everything",
  verbose = TRUE
)

final_results <- fit_resamples(
  this_wflow,
  resamples = folds,
  control = race_ctrl
) 
  
toc()
```

```{r}
final_predictions = collect_predictions(final_results) 

#plot final roc curve
rocobj = roc(final_predictions$binary_response, final_predictions$.pred_1)
auc = round(auc(final_predictions$binary_response, final_predictions$.pred_1),4)

ggroc(rocobj) +
  ggtitle(paste0('ROC Curve ', '(AUC = ', auc, ')'))

ggsave(here('figures/PDX_modelling/PDX_LINCS_klaeger_best_model_CV.png'))
```